<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Resultados de Encuestas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        hr.custom-line {
            border: none;
            height: 5px;
            background-color: #0193cf;
            opacity: 1;
            margin: 0;
        }

        canvas.chart-circle {
            width: 60px !important;
            height: 60px !important;
        }


    </style>
</head>
<body>
    <header class="text-center my-3">
        <img src="https://kentek.com.mx/Imagenes/kenteklogo.png" alt="Kentek Logo" class="mx-auto d-block" style="max-width: 200px; height: auto;">
        <br>
        <hr class="custom-line" />
    </header>
    
    <div class="container mt-3 d-flex justify-content-start">
        <a href="/" class="btn btn-link text-decoration-none">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#0d6efd" class="bi bi-arrow-left" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M15 8a.5.5 0 0 1-.5.5H2.707l4.147 4.146a.5.5 0 0 1-.708.708l-5-5a.5.5 0 0 1 0-.708l5-5a.5.5 0 1 1 .708.708L2.707 7.5H14.5A.5.5 0 0 1 15 8z"/>
            </svg>
        </a>
    </div>

    <div class="container mt-4 pb-5">
        <h1 class="text-center">Resultados de Encuestas</h1>

        <form method="get" action="/resultados" class="my-4 d-flex justify-content-center">
            <input type="date" name="fecha_inicio" class="form-control w-50 me-2">
            <input type="date" name="fecha_fin" class="form-control w-50 me-2">
            <button type="submit" class="btn btn-primary">Buscar</button>
        </form>

        <table class="table table-bordered text-center align-middle">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Cliente</th>
                    <th>Calidad</th>
                    <th>Entregas</th>
                    <th>Servicio</th>
                    <th>Promedio</th>
                    <th>Fecha de Env√≠o</th>
                    <th>Fecha de Respuesta</th>
                </tr>
            </thead>
            <tbody>
                {% for fila in resumenes %}
                <tr>
                    <td><a href="{{ url_for('detalle', id_encuesta=fila[0]) }}">{{ fila[0] }}</a></td>
                    <td>{{ fila[1] }}</td>
                    <td>
                        <div class="d-flex flex-column align-items-center justify-content-center">
                            <canvas class="chart-circle" id="calidad-chart-{{loop.index}}"></canvas>
                            <div>{{ (fila[2] * 20) | round(1) }}%</div>
                        </div>
                    </td>
                    <td>
                        <div class="d-flex flex-column align-items-center justify-content-center">
                            <canvas class="chart-circle" id="entregas-chart-{{loop.index}}"></canvas>
                            <div>{{ (fila[3] * 20) | round(1) }}%</div>
                        </div>
                    </td>
                    <td>
                        <div class="d-flex flex-column align-items-center justify-content-center">
                            <canvas class="chart-circle" id="servicio-chart-{{loop.index}}"></canvas>
                            <div>{{ (fila[4] * 20) | round(1) }}%</div>
                        </div>
                    </td>
                    <td>
                        <div class="d-flex flex-column align-items-center justify-content-center">
                            <canvas class="chart-circle" id="promedio-chart-{{loop.index}}"></canvas>
                            <div>{{ (fila[5] * 20) | round(1) }}%</div>
                        </div>
                    </td>
                    <td>{{ fila[6] }}</td>
                    <td>{{ fila[7] }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% if resumenes|length == 0 %}
            <p class="text-center text-danger mt-4">No se encontraron encuestas con esta fecha.</p>
        {% endif %}
        
        <div class="container mt-3 d-flex justify-content-start">
            <a href="/" class="btn btn-link text-decoration-none">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#0d6efd" class="bi bi-arrow-left" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M15 8a.5.5 0 0 1-.5.5H2.707l4.147 4.146a.5.5 0 0 1-.708.708l-5-5a.5.5 0 0 1 0-.708l5-5a.5.5 0 1 1 .708.708L2.707 7.5H14.5A.5.5 0 0 1 15 8z"/>
                </svg>
            </a>
        </div>
    </div>

    <script>
        const resumenes = {{ resumenes | tojson }};

        resumenes.forEach((fila, index) => {
            const datos = [
                { id: 'calidad', valor: Math.round(fila[2] * 20) },
                { id: 'entregas', valor: Math.round(fila[3] * 20) },
                { id: 'servicio', valor: Math.round(fila[4] * 20) },
                { id: 'promedio', valor: Math.round(fila[5] * 20) },
            ];

            datos.forEach(metric => {
                const canvas = document.getElementById(`${metric.id}-chart-${index + 1}`);
                if (!canvas) return;
                const ctx = canvas.getContext('2d');

                let color = '#0193cf';
                if (metric.id === 'promedio') {
                    color = metric.valor >= 85 ? '#28a745' : '#dc3545';
                }

                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        datasets: [{
                            data: [metric.valor, 100 - metric.valor],
                            backgroundColor: [color, '#e0e0e0'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        cutout: '70%',
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: false },
                            
                        }
                    }
                });
            });
        });
    </script>

</body>
</html>
